import{j as e,o as fe,F as W,G as y,p as be,q as I,n as N,r as Ce,g as A,e as T,N as X,s as ve,h as ne,T as D,t as ye,v as Se,f,w as b,x as ie,b as we,d as le,y as F,L as ke,D as Ee}from"./mantine-8JTekVFe.js";import{l as C,r as p}from"./react-BFtFWddK.js";import{L as Z,d as ce,e as ue,f as B,u as k,g as ae,h as oe,i as Q,j as U,k as Le,l as Re,m as Ne,n as Me,o as Te,p as Pe,q as Oe,t as ze,v as Ae,w as _e,x as Ie,y as De,M as K,z as Be,A as Fe,a as Je,B as de,C as Ge,D as Ve,F as $e,G as Ke,H as qe,I as He,J as Ye,K as We,N as Ze,O as Xe,P as q,Q as he,S as xe,T as Qe,U as Ue,V as H,W as et,X as O,Y as tt,r as z,Z as J,_ as ge,$ as st,b as nt,c as at,a0 as ot,E as rt}from"./index-DXrdOzrB.js";import{u as P}from"./use-translated-name-BhARIcv6.js";import{P as it,a as lt}from"./pantone-input-CJ7ff5aB.js";import{c as Y}from"./palette-card.module-BXpITapC.js";const ct="_row_1uk92_1",ut={row:ct},dt=n=>{var s;const{onUpdate:a,onLangSwitch:l,onRemove:i}=n,x=(s=n.entries)!=null?s:[],{t:c}=C(),{translateName:h}=P(),o=Object.entries(Z).map(([d,t])=>({value:d,label:h(t),disabled:x.some(r=>r[0]===d)})),u=()=>{const d=Object.keys(Z).filter(t=>!x.find(r=>r[0]===t))[0];a(d,"")};return e.jsx(fe,{legend:c("Multi-languages"),children:x.map(([d,t],r,m)=>e.jsxs(W,{pt:4,align:"center","data-testid":"entry-card-stack-"+d,children:[e.jsxs(y,{gap:"xs",flex:1,grow:!0,children:[e.jsx(be,{size:"xs","aria-label":c("Language"),value:d,onChange:j=>l(d,j),data:o,searchable:!0}),e.jsx(I,{size:"xs","aria-label":c("Name"),placeholder:c("Enter name"),value:t,onChange:({currentTarget:{value:j}})=>a(d,j)})]}),e.jsxs(W,{ml:8,wrap:"nowrap",children:[r===m.length-1?e.jsx(N,{size:"sm",variant:"filled","aria-label":c("Add a name in another language"),title:c("Add a name in another language"),onClick:u,children:e.jsx(ce,{})}):e.jsx(Ce,{w:22}),m.length>1&&e.jsx(N,{size:"sm",variant:"outline","aria-label":c("Remove this name"),title:c("Remove this name"),onClick:()=>i(d),ml:4,children:e.jsx(ue,{})})]})]},r))})};function ee(n){return e.jsx(dt,{...n})}function ht(){const{t:n,i18n:a}=C(),{translateName:l}=P(),i=B(),{countryList:x}=k(t=>t.app),{country:c,newCountry:h,countryName:o,newCountryLangs:u}=k(t=>t.ticket);p.useEffect(()=>{if(c&&c!=="new"){const t=x.find(r=>r.id===c);t&&(i(ae(c)),i(oe(t.languages)))}},[c]);const s=[{value:"",label:n("Please select..."),disabled:!0},...x.filter(t=>t.id!=="UN").map(t=>({value:t.id,label:l(t.name)})).toSorted((t,r)=>t.label.localeCompare(r.label,a.languages[0])),{value:"new",label:n("Add a country/region...")}],d=Object.entries(Z).map(([t,r])=>({value:t,label:l(r)}));return e.jsxs(Q,{children:[e.jsx(U,{children:e.jsx(A,{order:2,size:"h4",children:n("Country/Region")})}),e.jsxs(T,{py:4,gap:"xs",children:[e.jsxs(y,{className:ut.row,children:[e.jsx(X,{label:n("Country/Region"),value:c,onChange:({currentTarget:{value:t}})=>i(Le(t)),data:s}),e.jsx(I,{label:n("Country/region code"),placeholder:"e.g. CN, HK, JP (ISO 3166-1 alpha-2)",value:h,onChange:({currentTarget:{value:t}})=>i(ae(t)),error:h&&!h.match(/^[A-Z]{2}$|^GB[A-Z]{3}$/)?n("Country code should be in the format of ISO 3166-1 alpha-2"):void 0,disabled:c!=="new"}),e.jsx(ve,{label:n("Official language"),value:u,onChange:t=>i(oe(t)),data:d,searchable:!0,disabled:c!=="new"})]}),c==="new"&&e.jsx(ee,{entries:o,onUpdate:(t,r)=>i(Me({lang:t,name:r})),onLangSwitch:(t,r)=>i(Ne({prevLang:t,nextLang:r})),onRemove:t=>i(Re(t))})]})]})}function xt(){const{t:n,i18n:a}=C(),l=B(),{translateName:i}=P(),{cityList:x}=k(t=>t.app),{country:c,city:h,newCity:o,cityName:u}=k(t=>t.ticket),s=[{value:"",label:n("Please select..."),disabled:!0},...x.filter(t=>t.country===c).map(t=>({value:t.id,label:i(t.name)})).toSorted((t,r)=>t.label.localeCompare(r.label,a.languages[0])),{value:"new",label:n("Add a city")+"..."}],d=async t=>{if(t==="new"){l(Ae("new"));return}const r=await _e(t,x);l(r?Ie(r):De())};return e.jsxs(Q,{children:[e.jsx(U,{children:e.jsx(A,{order:2,size:"h4",children:n("City")})}),e.jsxs(T,{py:4,gap:"xs",children:[e.jsxs(y,{align:"flex-start",grow:!0,children:[e.jsx(X,{label:n("City"),value:h,onChange:({currentTarget:{value:t}})=>d(t),data:s}),h==="new"&&e.jsx(I,{label:n("City code"),placeholder:"e.g. hongkong, guangzhou, shanghai",value:o,onChange:({currentTarget:{value:t}})=>l(Te(t)),error:o&&o.match(/[^a-z]/)?"City code should contain lower case letters only":void 0})]}),h==="new"&&e.jsx(ee,{entries:u,onUpdate:(t,r)=>l(ze({lang:t,name:r})),onLangSwitch:(t,r)=>l(Oe({prevLang:t,nextLang:r})),onRemove:t=>l(Pe(t))})]})]})}function gt({lineDetail:n,onUpdate:a,onMoveUp:l,onMoveDown:i,onCopy:x,onRemove:c,onNameUpdate:h,onNameRemove:o,onLangSwitch:u}){var _,w;const{t:s}=C(),{translateName:d}=P(),{pantoneReady:t}=k(g=>g.app),[r,m]=p.useState(!!n.pantone),[j,E]=p.useState(!1),S=p.useRef(null),L=()=>{j?E(!1):(E(!0),setTimeout(()=>{var g;(g=S.current)==null||g.scrollIntoView({behavior:"smooth"})},0))},G=[{label:s("Black"),value:K.black},{label:s("White"),value:K.white}],v=n.fg===K.black?"black":"white";return e.jsxs(ne,{ref:S,className:Y.editable,withBorder:!0,children:[e.jsxs(ne.Section,{bg:n.colour,className:Y["card-section"],children:[e.jsx(D,{span:!0,style:{color:v},children:d(Object.fromEntries(n.nameEntity))}),e.jsxs(y,{gap:"xs",ml:"auto",children:[e.jsx(N,{size:"xs",variant:"subtle",color:v,"aria-label":s("Move up"),title:s("Move up"),onClick:l,children:e.jsx(Be,{})}),e.jsx(N,{size:"xs",variant:"subtle",color:v,"aria-label":s("Move down"),title:s("Move down"),onClick:i,children:e.jsx(Fe,{})}),e.jsx(N,{size:"xs",variant:"subtle",color:v,"aria-label":s("Edit"),title:s("Edit"),onClick:L,children:e.jsx(Je,{})}),e.jsx(N,{size:"xs",variant:"subtle",color:v,"aria-label":s("Duplicate"),title:s("Duplicate"),onClick:x,children:e.jsx(de,{})}),e.jsx(N,{size:"xs",variant:"subtle",color:v,"aria-label":s("Remove"),title:s("Remove"),onClick:c,children:e.jsx(ue,{})})]})]}),j&&e.jsxs(T,{gap:"xs",mt:"xs",children:[e.jsxs(y,{gap:"xs",className:Y["editable-group"],children:[e.jsx(I,{label:s("Line code"),placeholder:"e.g. twl, gz1, sh1",value:n.id,onChange:({currentTarget:{value:g}})=>a==null?void 0:a({id:g}),error:(_=n.id)!=null&&_.match(/[^a-z0-9]/)?s("Line code should be alphanumeric"):void 0}),e.jsx(ye,{label:s("Background colour"),value:n.colour,onChange:g=>a==null?void 0:a({colour:g}),disabled:t&&r}),t&&e.jsx(Se,{label:s("Use PantoneÂ®"),checked:r,onChange:({currentTarget:{checked:g}})=>m(g),mt:"xl"}),t&&r&&e.jsx(it,{value:(w=n.pantone)!=null?w:"",onChange:(g,R)=>a==null?void 0:a({pantone:g,colour:R})}),e.jsx(Ge,{size:"sm",label:s("Foreground colour"),data:G,value:n.fg,onChange:g=>a==null?void 0:a({fg:g})})]}),e.jsx(ee,{entries:n.nameEntity,onUpdate:(g,R)=>h==null?void 0:h(g,R),onLangSwitch:(g,R)=>u==null?void 0:u(g,R),onRemove:g=>o==null?void 0:o(g)})]})]})}function pt(){const{t:n}=C(),a=B(),l=k(o=>o.ticket.lines),i=p.useRef(null),x=p.useCallback(()=>{setTimeout(()=>{var o,u;(u=(o=i.current)==null?void 0:o.lastElementChild)==null||u.scrollIntoView({behavior:"smooth"})},0)},[i.current]),c=o=>{a(Ze(o)),x()},h=()=>{a(Xe()),x()};return e.jsxs(Q,{children:[e.jsxs(U,{children:[e.jsx(A,{order:2,size:"h4",children:n("Lines")}),e.jsx(lt,{ml:"auto"})]}),e.jsxs(T,{ref:i,py:4,gap:"xs",children:[Object.entries(l).map(([o,u])=>e.jsx(gt,{lineDetail:u,onUpdate:s=>a(We({entryId:o,updates:s})),onMoveUp:()=>a(Ye(o)),onMoveDown:()=>a(He(o)),onCopy:()=>c(o),onRemove:()=>a(qe(o)),onNameUpdate:(s,d)=>a(Ke({entryId:o,lang:s,name:d})),onLangSwitch:(s,d)=>a($e({entryId:o,prevLang:s,nextLang:d})),onNameRemove:s=>a(Ve({entryId:o,lang:s}))},o)),e.jsx(f,{size:"xs",variant:"outline",leftSection:e.jsx(ce,{}),ml:"auto",onClick:h,children:n("Add a line")})]})]})}const mt="_content_euz2o_1",jt="_body_euz2o_7",M={content:mt,body:jt,"stepper-root":"_stepper-root_euz2o_14","stepper-content":"_stepper-content_euz2o_21","step-body":"_step-body_euz2o_28"};function ft(n){const{countryErrors:a,cityErrors:l,lineErrors:i,onIgnore:x,onClose:c}=n,{t:h}=C(),{translateName:o}=P();return e.jsxs(e.Fragment,{children:[e.jsxs(T,{gap:"xs",className:M["step-body"],children:[e.jsx(D,{children:h("Your inputs contain the following errors. Please consider fixing it before submitting.")}),a.length>0&&e.jsxs(e.Fragment,{children:[e.jsx(A,{order:3,size:"h5",children:h("Country/Region")}),e.jsx(b,{size:"sm",withPadding:!0,"aria-label":"List of country errors",children:a.map((u,s)=>e.jsx(b.Item,{children:o(q[u])},s))})]}),l.length>0&&e.jsxs(e.Fragment,{children:[e.jsx(A,{order:3,size:"h5",children:h("City")}),e.jsx(b,{size:"sm",withPadding:!0,"aria-label":"List of city errors",children:l.map((u,s)=>e.jsx(b.Item,{children:o(q[u])},s))})]}),Object.values(i).flat().length>0&&e.jsxs(e.Fragment,{children:[e.jsx(A,{order:3,size:"h5",children:h("Lines")}),e.jsx(b,{size:"sm",withPadding:!0,"aria-label":"List of line errors",children:Object.entries(i).map(([u,s])=>e.jsxs(b.Item,{children:[u,e.jsx(b,{size:"sm",withPadding:!0,children:s.map((d,t)=>e.jsx(b.Item,{children:o(q[d])},t))})]},u))})]})]}),e.jsxs(y,{gap:"sm",pt:"xs",children:[e.jsx(f,{variant:"default",ml:"auto",onClick:c,children:h("Go back")}),e.jsx(f,{onClick:x,children:h("Submit anyway")})]})]})}const re=n=>{var a;return!!((a=n.match(/^https?:\/\//))!=null&&a[0])};function bt(n){const{dataSource:a,onDataSourceChange:l,refLink:i,onRefLinkChange:x,justification:c,onJustificationChange:h,onPrev:o,onNext:u}=n,{t:s}=C(),{translateName:d}=P(),t=[{value:"",label:s("Please select..."),disabled:!0},...Object.entries(he).map(([m,j])=>({value:m,label:d(j)}))],r=!a||!i||!c||!re(i);return e.jsxs(e.Fragment,{children:[e.jsxs(T,{gap:"xs",className:M["step-body"],children:[e.jsx(D,{children:s("Please provide suitable source and justification.")}),e.jsx(X,{label:s("Data source"),value:a,onChange:({currentTarget:{value:m}})=>l(m),data:t}),e.jsx(I,{label:s("Reference link"),placeholder:s("Enter a valid URL, e.g.")+" https://en.wikipedia.org",value:i,onChange:({currentTarget:{value:m}})=>x(m),error:i&&!re(i)?s("URL is invalid"):void 0}),e.jsx(ie,{label:s("Justification"),placeholder:s("Briefly describe your changes and provide justification"),value:c,onChange:({currentTarget:{value:m}})=>h(m),autosize:!0,minRows:3})]}),e.jsxs(y,{gap:"sm",pt:"xs",children:[o&&e.jsx(f,{variant:"default",onClick:o,leftSection:e.jsx(xe,{}),children:s("Previous")}),e.jsx(f,{ml:"auto",onClick:u,rightSection:e.jsx(Qe,{}),disabled:r,children:s("Next")})]})]})}function Ct(n){var E,S;const{countryEntry:a,cityEntry:l,paletteList:i,dataSource:x,refLink:c,justification:h,onPrev:o}=n,{t:u}=C(),{translateName:s}=P(),d=p.useRef(null),t=["**Data source:** ".concat(x?s(he[x]):"(REPLACE ME)"),"**Reference link:** ".concat(c||"(REPLACE ME)"),"**Justification:** ".concat(h||"(REPLACE ME)"),Ue,H("country",a),H("city",l),H("lines",i)].join("\n\n"),r=new URLSearchParams({template:"new-palettes-request.md",labels:"resources",title:"Resources: New palettes of "+((E=l==null?void 0:l.name)==null?void 0:E.en),body:t}),m=new URLSearchParams({template:"new-palettes-request.md",labels:"resources",title:"Resources: New palettes of "+((S=l==null?void 0:l.name)==null?void 0:S.en)}),j=async()=>{d!=null&&d.current&&(d.current.select(),await navigator.clipboard.writeText(t))};return e.jsxs(e.Fragment,{children:[e.jsxs(T,{gap:"xs",className:M["step-body"],children:[e.jsx(D,{children:u("If the button below doesn't work for you, please follow the instructions below:")}),e.jsxs(b,{type:"ordered",withPadding:!0,children:[e.jsxs(b.Item,{children:[u("Open")," ",e.jsxs(we,{href:"https://github.com/railmapgen/rmg-palette/issues/new?"+m.toString(),target:"_blank",children:["Issue: New Palettes Request ",e.jsx(et,{})]})]}),e.jsxs(b.Item,{children:[u("Paste following text to the issue body")," ",e.jsx(f,{size:"xs",variant:"light",leftSection:e.jsx(de,{}),onClick:j,children:u("Copy")}),e.jsx(ie,{ref:d,readOnly:!0,defaultValue:t,onClick:({target:L})=>L.select(),mt:"xs",autosize:!0,maxRows:3})]})]})]}),e.jsxs(y,{gap:"sm",pt:"xs",children:[e.jsx(f,{variant:"default",onClick:o,leftSection:e.jsx(xe,{}),children:u("Previous")}),e.jsx(f,{ml:"auto",onClick:()=>window.open("https://github.com/railmapgen/rmg-palette/issues/new?"+r.toString(),"_blank"),children:u("1-click open issue")})]})]})}function vt(n){const{isOpen:a,onClose:l}=n,{t:i}=C(),[x,c]=p.useState([]),[h,o]=p.useState([]),[u,s]=p.useState({}),[d,t]=p.useState(""),[r,m]=p.useState(""),[j,E]=p.useState(""),[S,L]=p.useState(!1),[G,v]=p.useState(!1),{countryList:_}=k($=>$.app),w=k($=>$.ticket),g=O.getCountryEntry(w),R=O.getCityEntry(w),pe=O.getPalettes(w);p.useEffect(()=>{a?(c(O.getCountryErrors(w)),o(O.getCityErrors(w,_)),s(O.getLineErrors(w,_))):(L(!1),t(""),m(""),E(""),v(!1))},[a]);const te=x.length>0||h.length>0||Object.values(u).flat().length>0,V=te&&!S,se=!V&&!G,me=()=>V?0:se?1:2,je=()=>{!V&&!se&&z.storage.remove(J),l()};return e.jsx(le,{classNames:{content:M.content,body:M.body},opened:a,onClose:je,title:i("Submit palettes"),children:e.jsxs(F,{active:me(),classNames:{root:M["stepper-root"],content:M["stepper-content"]},children:[e.jsx(F.Step,{label:i("Validate"),color:S?"orange":void 0,completedIcon:S?e.jsx(tt,{size:24}):void 0,children:e.jsx(ft,{countryErrors:x,cityErrors:h,lineErrors:u,onIgnore:()=>L(!0),onClose:l})}),e.jsx(F.Step,{label:i("Justify"),children:e.jsx(bt,{dataSource:d,onDataSourceChange:t,refLink:r,onRefLinkChange:m,justification:j,onJustificationChange:E,onPrev:te?()=>L(!1):void 0,onNext:()=>v(!0)})}),e.jsx(F.Step,{label:i("Submit"),children:e.jsx(Ct,{countryEntry:g,cityEntry:R,paletteList:pe,dataSource:d,refLink:r,justification:j,onPrev:()=>v(!1)})})]})})}function yt(n){const{isOpen:a,onClose:l,incomingState:i}=n,{t:x}=C(),c=B(),h=()=>{z.storage.remove(J),l()},o=()=>{i&&c(ge(i)),l()};return e.jsx(le,{opened:a,onClose:l,title:x("Unsaved draft"),children:e.jsxs(W,{direction:"column",children:[e.jsx(D,{children:x("Do you want to continue with your last unsaved ticket?")}),e.jsxs(y,{gap:"xs",mt:"xs",children:[e.jsx(f,{variant:"default",ml:"auto",onClick:h,children:x("Discard")}),e.jsx(f,{onClick:o,children:x("Continue")})]})]})})}function Nt(){const{t:n}=C(),a=B(),{isDataLoading:l}=k(t=>t.app),[i,x]=p.useState(),[c,h]=p.useState(!1),[o,u]=p.useState(!1);p.useEffect(()=>{const t=z.storage.get(J);if(t)try{const r=JSON.parse(t);Object.keys(r.lines).length>0&&Object.values(r.lines)[0].id&&(x(r),h(!0))}catch(r){st.error("<TicketView/>, unable to restore draft ticket",t)}},[]);const s=()=>{z.openApp({appId:"rmg-palette"})},d=()=>{a(ge()),z.storage.remove(J),z.event(rt.RESET_TICKET,{})};return e.jsxs(nt,{w:{base:"100%",sm:600},style:{alignSelf:"center"},children:[e.jsx(ke,{visible:l}),e.jsxs(at,{direction:"column",px:"xs",style:{overflowY:"auto"},children:[e.jsx(ht,{}),e.jsx(xt,{}),e.jsx(pt,{})]}),e.jsx(Ee,{}),e.jsx(ot,{children:e.jsxs(y,{flex:1,gap:"sm",children:[e.jsx(f,{variant:"default",onClick:s,children:n("Go back")}),e.jsx(f,{variant:"default",ml:"auto",onClick:d,children:n("Reset")}),e.jsx(f,{onClick:()=>u(!0),children:n("Submit")})]})}),e.jsx(yt,{isOpen:c,onClose:()=>h(!1),incomingState:i}),e.jsx(vt,{isOpen:o,onClose:()=>u(!1)})]})}export{Nt as default};
