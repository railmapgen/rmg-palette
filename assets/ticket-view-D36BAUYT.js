import{j as e,n as fe,F as Y,G as v,o as be,p as I,i as R,q as re,s as Ce,t as ie,u as X,v as Z,T as z,w as N,N as Q,x as ve,C as se,f as _,y as ye,z as Se,M as we,D as le,E as ke,H as Ee,B as j,I as f,J as ce,K as ue,O as Le,P as Re,Q as Me,U as de,V as B,W as Ne,r as O,l as Pe,k as Te,L as Oe,m as ze,X as Ae,Y as Ie}from"./mantine-BKUBcjGe.js";import{l as b,r as m}from"./react-DXyAvNqt.js";import{L as W,a as D,u as w,b as ne,c as ae,d as _e,r as De,e as Be,f as Fe,g as Je,h as Ge,i as Ve,j as Ke,k as $e,l as qe,p as He,m as Ye,M as K,n as We,o as Xe,q as Ze,t as Qe,v as Ue,w as et,x as tt,y as st,z as nt,I as $,D as he,G as at,A as q,B as T,C as F,F as xe,E as ot}from"./index-Bod-0Tca.js";import{u as P}from"./use-translated-name-OVD1BDsz.js";import{C as rt,P as it,a as lt}from"./compatible-colour-input-B8poq9wL.js";import{c as H}from"./palette-card.module-BXpITapC.js";const ct="_row_1uk92_1",ut={row:ct},dt=n=>{const{onUpdate:a,onLangSwitch:i,onRemove:r}=n,h=n.entries??[],{t:l}=b(),{translateName:d}=P(),o=Object.entries(W).map(([s,x])=>({value:s,label:d(x),disabled:h.some(t=>t[0]===s)})),c=()=>{const s=Object.keys(W).filter(x=>!h.find(t=>t[0]===x))[0];a(s,"")};return e.jsx(fe,{legend:l("Multi-languages"),children:h.map(([s,x],t,u)=>e.jsxs(Y,{pt:4,align:"center","data-testid":"entry-card-stack-"+s,children:[e.jsxs(v,{gap:"xs",flex:1,grow:!0,children:[e.jsx(be,{size:"xs","aria-label":l("Language"),value:s,onChange:p=>i(s,p),data:o,searchable:!0}),e.jsx(I,{size:"xs","aria-label":l("Name"),placeholder:l("Enter name"),value:x,onChange:({currentTarget:{value:p}})=>a(s,p)})]}),e.jsxs(Y,{ml:8,wrap:"nowrap",children:[t===u.length-1?e.jsx(R,{size:"sm",variant:"filled","aria-label":l("Add a name in another language"),title:l("Add a name in another language"),onClick:c,children:e.jsx(re,{})}):e.jsx(Ce,{w:22}),u.length>1&&e.jsx(R,{size:"sm",variant:"outline","aria-label":l("Remove this name"),title:l("Remove this name"),onClick:()=>r(s),ml:4,children:e.jsx(ie,{})})]})]},t))})};function U(n){return e.jsx(dt,{...n})}function ht(){const{t:n,i18n:a}=b(),{translateName:i}=P(),r=D(),{countryList:h}=w(t=>t.app),{country:l,newCountry:d,countryName:o,newCountryLangs:c}=w(t=>t.ticket);m.useEffect(()=>{if(l&&l!=="new"){const t=h.find(u=>u.id===l);t&&(r(ne(l)),r(ae(t.languages)))}},[l]);const s=[{value:"",label:n("Please select..."),disabled:!0},...h.filter(t=>t.id!=="UN").map(t=>({value:t.id,label:i(t.name)})).toSorted((t,u)=>t.label.localeCompare(u.label,a.languages[0])),{value:"new",label:n("Add a country/region...")}],x=Object.entries(W).map(([t,u])=>({value:t,label:i(u)}));return e.jsxs(X,{children:[e.jsx(Z,{children:e.jsx(z,{order:2,size:"h4",children:n("Country/Region")})}),e.jsxs(N,{py:4,gap:"xs",children:[e.jsxs(v,{className:ut.row,children:[e.jsx(Q,{label:n("Country/Region"),value:l,onChange:({currentTarget:{value:t}})=>r(_e(t)),data:s}),e.jsx(I,{label:n("Country/region code"),placeholder:"e.g. CN, HK, JP (ISO 3166-1 alpha-2)",value:d,onChange:({currentTarget:{value:t}})=>r(ne(t)),error:d&&!d.match(/^[A-Z]{2}$|^GB[A-Z]{3}$/)?n("Country code should be in the format of ISO 3166-1 alpha-2"):void 0,disabled:l!=="new"}),e.jsx(ve,{label:n("Official language"),value:c,onChange:t=>r(ae(t)),data:x,searchable:!0,disabled:l!=="new"})]}),l==="new"&&e.jsx(U,{entries:o,onUpdate:(t,u)=>r(Fe({lang:t,name:u})),onLangSwitch:(t,u)=>r(Be({prevLang:t,nextLang:u})),onRemove:t=>r(De(t))})]})]})}function xt(){const{t:n,i18n:a}=b(),i=D(),{translateName:r}=P(),{cityList:h}=w(t=>t.app),{country:l,city:d,newCity:o,cityName:c}=w(t=>t.ticket),s=[{value:"",label:n("Please select..."),disabled:!0},...h.filter(t=>t.country===l).map(t=>({value:t.id,label:r(t.name)})).toSorted((t,u)=>t.label.localeCompare(u.label,a.languages[0])),{value:"new",label:n("Add a city")+"..."}],x=async t=>{if(t==="new"){i($e("new"));return}const u=await qe(t,h);i(u?He(u):Ye())};return e.jsxs(X,{children:[e.jsx(Z,{children:e.jsx(z,{order:2,size:"h4",children:n("City")})}),e.jsxs(N,{py:4,gap:"xs",children:[e.jsxs(v,{align:"flex-start",grow:!0,children:[e.jsx(Q,{label:n("City"),value:d,onChange:({currentTarget:{value:t}})=>x(t),data:s}),d==="new"&&e.jsx(I,{label:n("City code"),placeholder:"e.g. hongkong, guangzhou, shanghai",value:o,onChange:({currentTarget:{value:t}})=>i(Je(t)),error:o&&o.match(/[^a-z]/)?"City code should contain lower case letters only":void 0})]}),d==="new"&&e.jsx(U,{entries:c,onUpdate:(t,u)=>i(Ke({lang:t,name:u})),onLangSwitch:(t,u)=>i(Ve({prevLang:t,nextLang:u})),onRemove:t=>i(Ge(t))})]})]})}function gt({lineDetail:n,onUpdate:a,onMoveUp:i,onMoveDown:r,onCopy:h,onRemove:l,onNameUpdate:d,onNameRemove:o,onLangSwitch:c}){var A;const{t:s}=b(),{translateName:x}=P(),{pantoneReady:t}=w(g=>g.app),[u,p]=m.useState(!!n.pantone),[y,k]=m.useState(!1),S=m.useRef(null),E=()=>{y?k(!1):(k(!0),setTimeout(()=>{var g;(g=S.current)==null||g.scrollIntoView({behavior:"smooth"})},0))},J=[{label:s("Black"),value:K.black},{label:s("White"),value:K.white}],C=n.fg===K.black?"black":"white";return e.jsxs(se,{ref:S,className:H.editable,withBorder:!0,children:[e.jsxs(se.Section,{bg:n.colour,className:H["card-section"],children:[e.jsx(_,{span:!0,style:{color:C},children:x(Object.fromEntries(n.nameEntity))}),e.jsxs(v,{gap:"xs",ml:"auto",children:[e.jsx(R,{size:"xs",variant:"subtle",color:C,"aria-label":s("Move up"),title:s("Move up"),onClick:i,children:e.jsx(ye,{})}),e.jsx(R,{size:"xs",variant:"subtle",color:C,"aria-label":s("Move down"),title:s("Move down"),onClick:r,children:e.jsx(Se,{})}),e.jsx(R,{size:"xs",variant:"subtle",color:C,"aria-label":s("Edit"),title:s("Edit"),onClick:E,children:e.jsx(we,{})}),e.jsx(R,{size:"xs",variant:"subtle",color:C,"aria-label":s("Duplicate"),title:s("Duplicate"),onClick:h,children:e.jsx(le,{})}),e.jsx(R,{size:"xs",variant:"subtle",color:C,"aria-label":s("Remove"),title:s("Remove"),onClick:l,children:e.jsx(ie,{})})]})]}),y&&e.jsxs(N,{gap:"xs",mt:"xs",children:[e.jsxs(v,{gap:"xs",className:H["editable-group"],children:[e.jsx(I,{label:s("Line code"),placeholder:"e.g. twl, gz1, sh1",value:n.id,onChange:({currentTarget:{value:g}})=>a==null?void 0:a({id:g}),error:(A=n.id)!=null&&A.match(/[^a-z0-9]/)?s("Line code should be alphanumeric"):void 0}),e.jsx(rt,{label:s("Background colour"),value:n.colour,onChange:g=>a==null?void 0:a({colour:g}),disabled:t&&u}),t&&e.jsx(ke,{label:s("Use PantoneÂ®"),checked:u,onChange:({currentTarget:{checked:g}})=>p(g),mt:"xl"}),t&&u&&e.jsx(it,{value:n.pantone??"",onChange:(g,L)=>a==null?void 0:a({pantone:g,colour:L})}),e.jsx(Ee,{size:"sm",label:s("Foreground colour"),data:J,value:n.fg,onChange:g=>a==null?void 0:a({fg:g})})]}),e.jsx(U,{entries:n.nameEntity,onUpdate:(g,L)=>d==null?void 0:d(g,L),onLangSwitch:(g,L)=>c==null?void 0:c(g,L),onRemove:g=>o==null?void 0:o(g)})]})]})}function mt(){const{t:n}=b(),a=D(),i=w(o=>o.ticket.lines),r=m.useRef(null),h=m.useCallback(()=>{setTimeout(()=>{var o,c;(c=(o=r.current)==null?void 0:o.lastElementChild)==null||c.scrollIntoView({behavior:"smooth"})},0)},[r.current]),l=o=>{a(st(o)),h()},d=()=>{a(nt()),h()};return e.jsxs(X,{children:[e.jsxs(Z,{children:[e.jsx(z,{order:2,size:"h4",children:n("Lines")}),e.jsx(lt,{ml:"auto"})]}),e.jsxs(N,{ref:r,py:4,gap:"xs",children:[Object.entries(i).map(([o,c])=>e.jsx(gt,{lineDetail:c,onUpdate:s=>a(tt({entryId:o,updates:s})),onMoveUp:()=>a(et(o)),onMoveDown:()=>a(Ue(o)),onCopy:()=>l(o),onRemove:()=>a(Qe(o)),onNameUpdate:(s,x)=>a(Ze({entryId:o,lang:s,name:x})),onLangSwitch:(s,x)=>a(Xe({entryId:o,prevLang:s,nextLang:x})),onNameRemove:s=>a(We({entryId:o,lang:s}))},o)),e.jsx(j,{size:"xs",variant:"outline",leftSection:e.jsx(re,{}),ml:"auto",onClick:d,children:n("Add a line")})]})]})}const pt="_content_euz2o_1",jt="_body_euz2o_7",M={content:pt,body:jt,"stepper-root":"_stepper-root_euz2o_14","stepper-content":"_stepper-content_euz2o_21","step-body":"_step-body_euz2o_28"};function ft(n){const{countryErrors:a,cityErrors:i,lineErrors:r,onIgnore:h,onClose:l}=n,{t:d}=b(),{translateName:o}=P();return e.jsxs(e.Fragment,{children:[e.jsxs(N,{gap:"xs",className:M["step-body"],children:[e.jsx(_,{children:d("Your inputs contain the following errors. Please consider fixing it before submitting.")}),a.length>0&&e.jsxs(e.Fragment,{children:[e.jsx(z,{order:3,size:"h5",children:d("Country/Region")}),e.jsx(f,{size:"sm",withPadding:!0,"aria-label":"List of country errors",children:a.map((c,s)=>e.jsx(f.Item,{children:o($[c])},s))})]}),i.length>0&&e.jsxs(e.Fragment,{children:[e.jsx(z,{order:3,size:"h5",children:d("City")}),e.jsx(f,{size:"sm",withPadding:!0,"aria-label":"List of city errors",children:i.map((c,s)=>e.jsx(f.Item,{children:o($[c])},s))})]}),Object.values(r).flat().length>0&&e.jsxs(e.Fragment,{children:[e.jsx(z,{order:3,size:"h5",children:d("Lines")}),e.jsx(f,{size:"sm",withPadding:!0,"aria-label":"List of line errors",children:Object.entries(r).map(([c,s])=>e.jsxs(f.Item,{children:[c,e.jsx(f,{size:"sm",withPadding:!0,children:s.map((x,t)=>e.jsx(f.Item,{children:o($[x])},t))})]},c))})]})]}),e.jsxs(v,{gap:"sm",pt:"xs",children:[e.jsx(j,{variant:"default",ml:"auto",onClick:l,children:d("Go back")}),e.jsx(j,{onClick:h,children:d("Submit anyway")})]})]})}const oe=n=>{var a;return!!((a=n.match(/^https?:\/\//))!=null&&a[0])};function bt(n){const{dataSource:a,onDataSourceChange:i,refLink:r,onRefLinkChange:h,justification:l,onJustificationChange:d,onPrev:o,onNext:c}=n,{t:s}=b(),{translateName:x}=P(),t=[{value:"",label:s("Please select..."),disabled:!0},...Object.entries(he).map(([p,y])=>({value:p,label:x(y)}))],u=!a||!r||!l||!oe(r);return e.jsxs(e.Fragment,{children:[e.jsxs(N,{gap:"xs",className:M["step-body"],children:[e.jsx(_,{children:s("Please provide suitable source and justification.")}),e.jsx(Q,{label:s("Data source"),value:a,onChange:({currentTarget:{value:p}})=>i(p),data:t}),e.jsx(I,{label:s("Reference link"),placeholder:s("Enter a valid URL, e.g.")+" https://en.wikipedia.org",value:r,onChange:({currentTarget:{value:p}})=>h(p),error:r&&!oe(r)?s("URL is invalid"):void 0}),e.jsx(ce,{label:s("Justification"),placeholder:s("Briefly describe your changes and provide justification"),value:l,onChange:({currentTarget:{value:p}})=>d(p),autosize:!0,minRows:3})]}),e.jsxs(v,{gap:"sm",pt:"xs",children:[o&&e.jsx(j,{variant:"default",onClick:o,leftSection:e.jsx(ue,{}),children:s("Previous")}),e.jsx(j,{ml:"auto",onClick:c,rightSection:e.jsx(Le,{}),disabled:u,children:s("Next")})]})]})}function Ct(n){var k,S;const{countryEntry:a,cityEntry:i,paletteList:r,dataSource:h,refLink:l,justification:d,onPrev:o}=n,{t:c}=b(),{translateName:s}=P(),x=m.useRef(null),t=[`**Data source:** ${h?s(he[h]):"(REPLACE ME)"}`,`**Reference link:** ${l||"(REPLACE ME)"}`,`**Justification:** ${d||"(REPLACE ME)"}`,at,q("country",a),q("city",i),q("lines",r)].join(`

`),u=new URLSearchParams({template:"new-palettes-request.md",labels:"resources",title:"Resources: New palettes of "+((k=i==null?void 0:i.name)==null?void 0:k.en),body:t}),p=new URLSearchParams({template:"new-palettes-request.md",labels:"resources",title:"Resources: New palettes of "+((S=i==null?void 0:i.name)==null?void 0:S.en)}),y=async()=>{x!=null&&x.current&&(x.current.select(),await navigator.clipboard.writeText(t))};return e.jsxs(e.Fragment,{children:[e.jsxs(N,{gap:"xs",className:M["step-body"],children:[e.jsx(_,{children:c("If the button below doesn't work for you, please follow the instructions below:")}),e.jsxs(f,{type:"ordered",withPadding:!0,children:[e.jsxs(f.Item,{children:[c("Open")," ",e.jsxs(Re,{href:"https://github.com/railmapgen/rmg-palette/issues/new?"+p.toString(),target:"_blank",children:["Issue: New Palettes Request ",e.jsx(Me,{})]})]}),e.jsxs(f.Item,{children:[c("Paste following text to the issue body")," ",e.jsx(j,{size:"xs",variant:"light",leftSection:e.jsx(le,{}),onClick:y,children:c("Copy")}),e.jsx(ce,{ref:x,readOnly:!0,defaultValue:t,onClick:({target:E})=>E.select(),mt:"xs",autosize:!0,maxRows:3})]})]})]}),e.jsxs(v,{gap:"sm",pt:"xs",children:[e.jsx(j,{variant:"default",onClick:o,leftSection:e.jsx(ue,{}),children:c("Previous")}),e.jsx(j,{ml:"auto",onClick:()=>window.open("https://github.com/railmapgen/rmg-palette/issues/new?"+u.toString(),"_blank"),children:c("1-click open issue")})]})]})}function vt(n){const{isOpen:a,onClose:i}=n,{t:r}=b(),[h,l]=m.useState([]),[d,o]=m.useState([]),[c,s]=m.useState({}),[x,t]=m.useState(""),[u,p]=m.useState(""),[y,k]=m.useState(""),[S,E]=m.useState(!1),[J,C]=m.useState(!1),{countryList:A}=w(V=>V.app),g=w(V=>V.ticket),L=T.getCountryEntry(g),ge=T.getCityEntry(g),me=T.getPalettes(g);m.useEffect(()=>{a?(l(T.getCountryErrors(g)),o(T.getCityErrors(g,A)),s(T.getLineErrors(g,A))):(E(!1),t(""),p(""),k(""),C(!1))},[a]);const ee=h.length>0||d.length>0||Object.values(c).flat().length>0,G=ee&&!S,te=!G&&!J,pe=()=>G?0:te?1:2,je=()=>{!G&&!te&&O.storage.remove(F),i()};return e.jsx(de,{classNames:{content:M.content,body:M.body},opened:a,onClose:je,title:r("Submit palettes"),children:e.jsxs(B,{active:pe(),classNames:{root:M["stepper-root"],content:M["stepper-content"]},children:[e.jsx(B.Step,{label:r("Validate"),color:S?"orange":void 0,completedIcon:S?e.jsx(Ne,{size:24}):void 0,children:e.jsx(ft,{countryErrors:h,cityErrors:d,lineErrors:c,onIgnore:()=>E(!0),onClose:i})}),e.jsx(B.Step,{label:r("Justify"),children:e.jsx(bt,{dataSource:x,onDataSourceChange:t,refLink:u,onRefLinkChange:p,justification:y,onJustificationChange:k,onPrev:ee?()=>E(!1):void 0,onNext:()=>C(!0)})}),e.jsx(B.Step,{label:r("Submit"),children:e.jsx(Ct,{countryEntry:L,cityEntry:ge,paletteList:me,dataSource:x,refLink:u,justification:y,onPrev:()=>C(!1)})})]})})}function yt(n){const{isOpen:a,onClose:i,incomingState:r}=n,{t:h}=b(),l=D(),d=()=>{O.storage.remove(F),i()},o=()=>{r&&l(xe(r)),i()};return e.jsx(de,{opened:a,onClose:i,title:h("Unsaved draft"),children:e.jsxs(Y,{direction:"column",children:[e.jsx(_,{children:h("Do you want to continue with your last unsaved ticket?")}),e.jsxs(v,{gap:"xs",mt:"xs",children:[e.jsx(j,{variant:"default",ml:"auto",onClick:d,children:h("Discard")}),e.jsx(j,{onClick:o,children:h("Continue")})]})]})})}function Mt(){const{t:n}=b(),a=D(),{isDataLoading:i}=w(t=>t.app),[r,h]=m.useState(),[l,d]=m.useState(!1),[o,c]=m.useState(!1);m.useEffect(()=>{const t=O.storage.get(F);if(t)try{const u=JSON.parse(t);Object.keys(u.lines).length>0&&Object.values(u.lines)[0].id&&(h(u),d(!0))}catch{Pe.error("<TicketView/>, unable to restore draft ticket",t)}},[]);const s=()=>{O.openApp({appId:"rmg-palette"})},x=()=>{a(xe()),O.storage.remove(F),O.event(ot.RESET_TICKET,{})};return e.jsxs(Te,{w:{base:"100%",sm:600},style:{alignSelf:"center"},children:[e.jsx(Oe,{visible:i}),e.jsxs(ze,{direction:"column",px:"xs",style:{overflowY:"auto"},children:[e.jsx(ht,{}),e.jsx(xt,{}),e.jsx(mt,{})]}),e.jsx(Ae,{}),e.jsx(Ie,{children:e.jsxs(v,{flex:1,gap:"sm",children:[e.jsx(j,{variant:"default",onClick:s,children:n("Go back")}),e.jsx(j,{variant:"default",ml:"auto",onClick:x,children:n("Reset")}),e.jsx(j,{onClick:()=>c(!0),children:n("Submit")})]})}),e.jsx(yt,{isOpen:l,onClose:()=>d(!1),incomingState:r}),e.jsx(vt,{isOpen:o,onClose:()=>c(!1)})]})}export{Mt as default};
