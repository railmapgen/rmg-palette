import{j as e,$ as k,Q as W,t as M,a1 as ce,f as x,s as O,a3 as R,e as b,v as P,a0 as B,w as le,a4 as de,x as ue,a5 as he,a6 as Y,M as Q,a7 as Z,q as X,r as ee,F as q}from"./chakra-ec22443a.js";import{u as j,r as p,n as me}from"./react-7205637f.js";import{c as w,a as f,L as pe,j as xe,k as ge,l as je,m as F,n as J,o as fe,p as ye,q as Ce,t as Se,v as ve,w as be,x as ke,y as we,z as Le,A as Ee,B as Re,C as K,D as Ne,F as Me,G as Oe,H as Pe,I as Te,J as De,K as Ie,N as Ae,O as Ue,P as U,Q as ze,S as z,T as Be,U as v,r as y,V as N,W as se,h as Fe,i as Je,E as Ge}from"./index-194bc4d8.js";import{R as G,M as He,a as te,b as Ve,c as _e,d as qe}from"./index.esm-be13eb54.js";import{u as H,M as ne,g as Ke,L as $e}from"./line-detail-card-ce85976a.js";function We(){const{t:i,i18n:a}=j(),n=H(),t=w(),{countryList:d}=f(s=>s.app),{country:c,newCountry:l,countryName:r,newCountryLang:h}=f(s=>s.ticket),u={...d.map(s=>[s.id,n(s.name)]).sort((s,o)=>s[1].localeCompare(o[1],a.languages[0])).reduce((s,o)=>o[0]==="UN"?s:{...s,[o[0]]:o[1]},{"":i("Please select...")}),new:i("Add a country/region...")},m=Object.entries(pe).reduce((s,o)=>({...s,[o[0]]:n(o[1])}),{}),g=[{type:"select",label:i("Country/Region"),value:c,options:u,disabledOptions:[""],onChange:s=>t(xe(s))},{type:"input",label:i("Country/region code"),placeholder:"e.g. CN, HK, JP (ISO 3166-1 alpha-2)",value:l,validator:s=>s!==""&&!!s.match(/^[A-Z]{2}$|^GB[A-Z]{3}$/),onChange:s=>t(ge(s)),hidden:c!=="new"},{type:"select",label:i("Official language"),value:h,options:m,onChange:s=>t(je(s||void 0)),hidden:c!=="new"}];return e.jsxs(F,{children:[e.jsx(J,{children:e.jsx(k,{as:"h5",size:"sm",children:i("Country/Region")})}),e.jsxs(W.div,{px:1,children:[e.jsx(G,{fields:g}),c==="new"&&e.jsx(ne,{entries:r,onUpdate:(s,o)=>t(fe({lang:s,name:o})),onLangSwitch:(s,o)=>t(ye({prevLang:s,nextLang:o})),onRemove:s=>t(Ce(s))})]})]})}function Ye(){const{t:i,i18n:a}=j(),n=w(),t=H(),{cityList:d}=f(s=>s.app),{country:c,city:l,newCity:r,cityName:h}=f(s=>s.ticket),u={...d.filter(s=>s.country===c).map(s=>[s.id,t(s.name)]).sort((s,o)=>s[1].localeCompare(o[1],a.languages[0])).reduce((s,o)=>({...s,[o[0]]:o[1]}),{"":i("Please select...")}),new:i("Add a city")+"..."},m=async s=>{if(s==="new"){n(we("new"));return}const o=await Le(s,d);n(o?Ee(o):Re())},g=[{type:"select",label:i("City"),value:l,options:u,disabledOptions:[""],onChange:s=>m(s)},{type:"input",label:i("City code"),placeholder:"e.g. hongkong, guangzhou, shanghai",value:r,onChange:s=>n(Se(s)),validator:s=>s!==""&&!s.match(/[^a-z]/),hidden:l!=="new"}];return e.jsxs(F,{children:[e.jsx(J,{children:e.jsx(k,{as:"h5",size:"sm",children:i("City")})}),e.jsxs(W.div,{px:1,children:[e.jsx(G,{fields:g}),l==="new"&&e.jsx(ne,{entries:h,onUpdate:(s,o)=>n(ve({lang:s,name:o})),onLangSwitch:(s,o)=>n(be({prevLang:s,nextLang:o})),onRemove:s=>n(ke(s))})]})]})}function Qe(){const{t:i}=j(),a=w(),{pantoneReady:n}=f(t=>t.app);return p.useEffect(()=>{const t=new AbortController;return Ke("130 C",t.signal).then(d=>a(K(!!d))).catch(()=>a(K(!1))),()=>{t.abort()}},[]),e.jsx(M,{as:"i",fontSize:"xs",children:n===void 0?i("Checking Pantone service availability..."):n?i("Pantone service is ready")+" ✅":i("Pantone service is not available")+" ⚠️"})}function Ze(){const{t:i}=j(),a=w(),n=f(t=>t.ticket.lines);return e.jsxs(F,{children:[e.jsxs(J,{children:[e.jsx(k,{as:"h5",size:"sm",mr:"auto",children:i("Lines")}),e.jsx(Qe,{})]}),e.jsxs(ce,{spacing:1,px:1,children:[Object.entries(n).map(([t,d])=>e.jsx($e,{lineDetail:d,editable:!0,onUpdate:c=>a(Ne({entryId:t,updates:c})),onMoveUp:()=>a(Me(t)),onMoveDown:()=>a(Oe(t)),onCopy:()=>a(Pe(t)),onRemove:()=>a(Te(t)),onNameUpdate:(c,l)=>a(De({entryId:t,lang:c,name:l})),onLangSwitch:(c,l)=>a(Ie({entryId:t,prevLang:c,nextLang:l})),onNameRemove:c=>a(Ae({entryId:t,lang:c}))},t)),e.jsx(x,{size:"xs",variant:"ghost",leftIcon:e.jsx(He,{}),ml:"auto !important",onClick:()=>a(Ue()),children:i("Add a line")})]})]})}function Xe(i){const{countryErrors:a,cityErrors:n,lineErrors:t,onIgnore:d,onClose:c}=i,{t:l}=j(),r=H();return e.jsxs(e.Fragment,{children:[e.jsxs(O,{children:[e.jsx(M,{children:l("Your inputs contain the following errors. Please consider fixing it before submitting.")}),a.length>0&&e.jsxs(e.Fragment,{children:[e.jsx(k,{as:"h5",size:"sm",my:2,children:l("Country/Region")}),e.jsx(R,{"aria-label":"List of country errors",children:a.map((h,u)=>e.jsx(b,{children:r(U[h])},u))})]}),n.length>0&&e.jsxs(e.Fragment,{children:[e.jsx(k,{as:"h5",size:"sm",my:2,children:l("City")}),e.jsx(R,{"aria-label":"List of city errors",children:n.map((h,u)=>e.jsx(b,{children:r(U[h])},u))})]}),Object.values(t).flat().length>0&&e.jsxs(e.Fragment,{children:[e.jsx(k,{as:"h5",size:"sm",my:2,children:l("Lines")}),e.jsx(R,{"aria-label":"List of line errors",children:Object.entries(t).map(([h,u])=>e.jsxs(b,{children:[h,e.jsx(R,{children:u.map((m,g)=>e.jsx(b,{children:r(U[m])},g))})]},h))})]})]}),e.jsx(P,{children:e.jsxs(B,{children:[e.jsx(x,{onClick:d,children:l("Submit anyway")}),e.jsx(x,{colorScheme:"primary",onClick:c,children:l("Go back")})]})})]})}const $=i=>{var a;return!!((a=i.match(/^https?:\/\//))!=null&&a[0])};function es(i){const{refLink:a,onRefLinkChange:n,justification:t,onJustificationChange:d,onPrev:c,onNext:l}=i,{t:r}=j(),h=[{type:"input",value:a,label:r("Reference link"),placeholder:r("Enter a valid URL, e.g.")+" https://en.wikipedia.org",onChange:n,validator:$},{type:"textarea",value:t,label:r("Justification"),placeholder:r("Briefly describe your changes and provide justification"),onChange:d}],u=!a||!t||!$(a);return e.jsxs(e.Fragment,{children:[e.jsxs(O,{children:[e.jsx(M,{children:r("Please provide suitable source and justification.")}),e.jsx(G,{fields:h,minW:"full"})]}),e.jsxs(P,{children:[c&&e.jsx(x,{variant:"ghost",onClick:c,mr:"auto",leftIcon:e.jsx(te,{}),children:r("Previous")}),e.jsx(x,{colorScheme:"primary",onClick:l,rightIcon:e.jsx(Ve,{}),isDisabled:u,children:r("Next")})]})]})}function ss(i){var L,C;const{countryEntry:a,cityEntry:n,paletteList:t,refLink:d,justification:c,onPrev:l}=i,{t:r}=j(),h=le("primary.500","primary.300"),u=p.useRef(null),m=[`**Reference link:** ${d||"(REPLACE ME)"}`,`**Justification:** ${c||"(REPLACE ME)"}`,ze,z("country",a),z("city",n),z("lines",t)].join(`

`),g=new URLSearchParams({template:"new-palettes-request.md",labels:"resources",title:"Resources: New palettes of "+((L=n==null?void 0:n.name)==null?void 0:L.en),body:m}),s=new URLSearchParams({template:"new-palettes-request.md",labels:"resources",title:"Resources: New palettes of "+((C=n==null?void 0:n.name)==null?void 0:C.en)}),o=async()=>{u!=null&&u.current&&(u.current.select(),await navigator.clipboard.writeText(m))};return e.jsxs(e.Fragment,{children:[e.jsxs(O,{children:[e.jsx(M,{children:r("If the button below doesn't work for you, please follow the instructions below:")}),e.jsxs(de,{children:[e.jsxs(b,{children:[r("Open")," ",e.jsxs(ue,{color:h,href:"https://github.com/railmapgen/rmg-palette/issues/new?"+s.toString(),isExternal:!0,children:["Issue: New Palettes Request ",e.jsx(he,{as:_e})]})]}),e.jsxs(b,{children:[r("Paste following text to the issue body")," ",e.jsx(x,{size:"xs",leftIcon:e.jsx(qe,{}),onClick:o,children:r("Copy")}),e.jsx(Be,{ref:u,isReadOnly:!0,defaultValue:m,onClick:({target:T})=>T.select()})]})]})]}),e.jsxs(P,{children:[e.jsx(x,{variant:"ghost",onClick:l,mr:"auto",leftIcon:e.jsx(te,{}),children:r("Previous")}),e.jsx(x,{colorScheme:"primary",onClick:()=>window.open("https://github.com/railmapgen/rmg-palette/issues/new?"+g.toString(),"_blank"),children:r("1-click open issue")})]})]})}function ts(i){const{isOpen:a,onClose:n}=i,{t}=j(),[d,c]=p.useState([]),[l,r]=p.useState([]),[h,u]=p.useState({}),[m,g]=p.useState(""),[s,o]=p.useState(""),[L,C]=p.useState(!1),[T,D]=p.useState(!1),{countryList:V}=f(A=>A.app),S=f(A=>A.ticket),ae=v.getCountryEntry(S),ie=v.getCityEntry(S),oe=v.getPalettes(S);p.useEffect(()=>{a?(c(v.getCountryErrors(S)),r(v.getCityErrors(S,V)),u(v.getLineErrors(S,V))):(C(!1),g(""),o(""),D(!1))},[a]);const _=d.length>0||l.length>0||Object.values(h).flat().length>0,E=_&&!L,I=!E&&!T,re=()=>{!E&&!I&&y.storage.remove(N),n()};return e.jsxs(Y,{blockScrollOnMount:!1,isOpen:a,onClose:n,scrollBehavior:"inside",children:[e.jsx(Q,{}),e.jsxs(Z,{children:[e.jsx(X,{children:t("Submit palettes")}),e.jsx(ee,{onClick:re}),E&&e.jsx(Xe,{countryErrors:d,cityErrors:l,lineErrors:h,onIgnore:()=>C(!0),onClose:n}),I&&e.jsx(es,{refLink:m,onRefLinkChange:g,justification:s,onJustificationChange:o,onPrev:_?()=>C(!1):void 0,onNext:()=>D(!0)}),!E&&!I&&e.jsx(ss,{countryEntry:ae,cityEntry:ie,paletteList:oe,refLink:m,justification:s,onPrev:()=>D(!1)})]})]})}function ns(i){const{isOpen:a,onClose:n,incomingState:t}=i,{t:d}=j(),c=w(),l=()=>{y.storage.remove(N),n()},r=()=>{t&&c(se(t)),n()};return e.jsxs(Y,{isOpen:a,onClose:n,children:[e.jsx(Q,{}),e.jsxs(Z,{children:[e.jsx(X,{children:d("Unsaved draft")}),e.jsx(ee,{}),e.jsx(O,{children:d("Do you want to continue with your last unsaved ticket?")}),e.jsx(P,{children:e.jsxs(B,{children:[e.jsx(x,{onClick:l,children:d("Discard")}),e.jsx(x,{colorScheme:"primary",onClick:r,children:d("Continue")})]})})]})]})}function ls(){const{t:i}=j(),a=w(),n=me(),{isDataLoading:t}=f(s=>s.app),[d,c]=p.useState(),[l,r]=p.useState(!1),[h,u]=p.useState(!1);p.useEffect(()=>{const s=y.storage.get(N);if(s)try{const o=JSON.parse(s);Object.keys(o.lines).length>0&&Object.values(o.lines)[0].id&&(c(o),r(!0))}catch(o){console.error("TicketView:: unable to restore draft ticket",s)}},[]);const m=()=>{y.isStandaloneWindow()?n("/"):y.openApp("rmg-palette")},g=()=>{a(se()),y.storage.remove(N),y.event(Ge.RESET_TICKET,{})};return e.jsxs(Fe,{alignSelf:"center",sx:{width:{base:"100%",md:520}},children:[t&&e.jsx(Je,{isIndeterminate:!0}),e.jsxs(q,{direction:"column",flex:1,overflowY:"auto",bg:"inherit",children:[e.jsx(We,{}),e.jsx(Ye,{}),e.jsx(Ze,{})]}),e.jsxs(q,{my:2,children:[e.jsx(x,{size:"sm",onClick:m,children:i("Go back")}),e.jsxs(B,{ml:"auto",children:[e.jsx(x,{size:"sm",variant:"outline",onClick:g,children:i("Reset")}),e.jsx(x,{size:"sm",colorScheme:"primary",onClick:()=>u(!0),children:i("Submit")})]})]}),e.jsx(ns,{isOpen:l,onClose:()=>r(!1),incomingState:d}),e.jsx(ts,{isOpen:h,onClose:()=>u(!1)})]})}export{ls as default};
