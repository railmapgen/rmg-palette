import{j as e,n as fe,F as W,G as y,o as be,p as I,i as M,q as ie,s as Ce,t as le,u as X,v as Q,T as A,w as T,N as U,x as ve,C as ne,f as D,y as ye,z as we,M as Se,D as ce,E as ke,H as Ee,I as Le,B as f,J as b,K as ue,O as de,P as Re,Q as Me,U as Ne,V as he,W as F,X as Te,r as z,l as Pe,k as Oe,L as ze,m as Ae,Y as Ie,Z as _e}from"./mantine-DlaGph6_.js";import{l as C,r as m}from"./react-BQLc8TMF.js";import{L as Z,a as B,u as k,b as ae,c as oe,d as De,r as Be,e as Fe,f as Je,g as Ge,h as Ve,i as Ke,j as $e,k as qe,l as He,p as Ye,m as We,M as $,n as Ze,o as Xe,q as Qe,t as Ue,v as et,w as tt,x as st,y as nt,z as at,I as q,D as xe,G as ot,A as H,B as O,C as J,F as ge,E as rt}from"./index-LdIvZI_W.js";import{u as P}from"./use-translated-name-CNACQMVg.js";import{P as it,a as lt}from"./pantone-input-CrdFWbF2.js";import{c as Y}from"./palette-card.module-BXpITapC.js";const ct="_row_1uk92_1",ut={row:ct},dt=a=>{var s;const{onUpdate:n,onLangSwitch:l,onRemove:i}=a,x=(s=a.entries)!=null?s:[],{t:c}=C(),{translateName:h}=P(),o=Object.entries(Z).map(([d,t])=>({value:d,label:h(t),disabled:x.some(r=>r[0]===d)})),u=()=>{const d=Object.keys(Z).filter(t=>!x.find(r=>r[0]===t))[0];n(d,"")};return e.jsx(fe,{legend:c("Multi-languages"),children:x.map(([d,t],r,p)=>e.jsxs(W,{pt:4,align:"center","data-testid":"entry-card-stack-"+d,children:[e.jsxs(y,{gap:"xs",flex:1,grow:!0,children:[e.jsx(be,{size:"xs","aria-label":c("Language"),value:d,onChange:j=>l(d,j),data:o,searchable:!0}),e.jsx(I,{size:"xs","aria-label":c("Name"),placeholder:c("Enter name"),value:t,onChange:({currentTarget:{value:j}})=>n(d,j)})]}),e.jsxs(W,{ml:8,wrap:"nowrap",children:[r===p.length-1?e.jsx(M,{size:"sm",variant:"filled","aria-label":c("Add a name in another language"),title:c("Add a name in another language"),onClick:u,children:e.jsx(ie,{})}):e.jsx(Ce,{w:22}),p.length>1&&e.jsx(M,{size:"sm",variant:"outline","aria-label":c("Remove this name"),title:c("Remove this name"),onClick:()=>i(d),ml:4,children:e.jsx(le,{})})]})]},r))})};function ee(a){return e.jsx(dt,{...a})}function ht(){const{t:a,i18n:n}=C(),{translateName:l}=P(),i=B(),{countryList:x}=k(t=>t.app),{country:c,newCountry:h,countryName:o,newCountryLangs:u}=k(t=>t.ticket);m.useEffect(()=>{if(c&&c!=="new"){const t=x.find(r=>r.id===c);t&&(i(ae(c)),i(oe(t.languages)))}},[c]);const s=[{value:"",label:a("Please select..."),disabled:!0},...x.filter(t=>t.id!=="UN").map(t=>({value:t.id,label:l(t.name)})).toSorted((t,r)=>t.label.localeCompare(r.label,n.languages[0])),{value:"new",label:a("Add a country/region...")}],d=Object.entries(Z).map(([t,r])=>({value:t,label:l(r)}));return e.jsxs(X,{children:[e.jsx(Q,{children:e.jsx(A,{order:2,size:"h4",children:a("Country/Region")})}),e.jsxs(T,{py:4,gap:"xs",children:[e.jsxs(y,{className:ut.row,children:[e.jsx(U,{label:a("Country/Region"),value:c,onChange:({currentTarget:{value:t}})=>i(De(t)),data:s}),e.jsx(I,{label:a("Country/region code"),placeholder:"e.g. CN, HK, JP (ISO 3166-1 alpha-2)",value:h,onChange:({currentTarget:{value:t}})=>i(ae(t)),error:h&&!h.match(/^[A-Z]{2}$|^GB[A-Z]{3}$/)?a("Country code should be in the format of ISO 3166-1 alpha-2"):void 0,disabled:c!=="new"}),e.jsx(ve,{label:a("Official language"),value:u,onChange:t=>i(oe(t)),data:d,searchable:!0,disabled:c!=="new"})]}),c==="new"&&e.jsx(ee,{entries:o,onUpdate:(t,r)=>i(Je({lang:t,name:r})),onLangSwitch:(t,r)=>i(Fe({prevLang:t,nextLang:r})),onRemove:t=>i(Be(t))})]})]})}function xt(){const{t:a,i18n:n}=C(),l=B(),{translateName:i}=P(),{cityList:x}=k(t=>t.app),{country:c,city:h,newCity:o,cityName:u}=k(t=>t.ticket),s=[{value:"",label:a("Please select..."),disabled:!0},...x.filter(t=>t.country===c).map(t=>({value:t.id,label:i(t.name)})).toSorted((t,r)=>t.label.localeCompare(r.label,n.languages[0])),{value:"new",label:a("Add a city")+"..."}],d=async t=>{if(t==="new"){l(qe("new"));return}const r=await He(t,x);l(r?Ye(r):We())};return e.jsxs(X,{children:[e.jsx(Q,{children:e.jsx(A,{order:2,size:"h4",children:a("City")})}),e.jsxs(T,{py:4,gap:"xs",children:[e.jsxs(y,{align:"flex-start",grow:!0,children:[e.jsx(U,{label:a("City"),value:h,onChange:({currentTarget:{value:t}})=>d(t),data:s}),h==="new"&&e.jsx(I,{label:a("City code"),placeholder:"e.g. hongkong, guangzhou, shanghai",value:o,onChange:({currentTarget:{value:t}})=>l(Ge(t)),error:o&&o.match(/[^a-z]/)?"City code should contain lower case letters only":void 0})]}),h==="new"&&e.jsx(ee,{entries:u,onUpdate:(t,r)=>l($e({lang:t,name:r})),onLangSwitch:(t,r)=>l(Ke({prevLang:t,nextLang:r})),onRemove:t=>l(Ve(t))})]})]})}function gt({lineDetail:a,onUpdate:n,onMoveUp:l,onMoveDown:i,onCopy:x,onRemove:c,onNameUpdate:h,onNameRemove:o,onLangSwitch:u}){var _,S;const{t:s}=C(),{translateName:d}=P(),{pantoneReady:t}=k(g=>g.app),[r,p]=m.useState(!!a.pantone),[j,E]=m.useState(!1),w=m.useRef(null),L=()=>{j?E(!1):(E(!0),setTimeout(()=>{var g;(g=w.current)==null||g.scrollIntoView({behavior:"smooth"})},0))},G=[{label:s("Black"),value:$.black},{label:s("White"),value:$.white}],v=a.fg===$.black?"black":"white";return e.jsxs(ne,{ref:w,className:Y.editable,withBorder:!0,children:[e.jsxs(ne.Section,{bg:a.colour,className:Y["card-section"],children:[e.jsx(D,{span:!0,style:{color:v},children:d(Object.fromEntries(a.nameEntity))}),e.jsxs(y,{gap:"xs",ml:"auto",children:[e.jsx(M,{size:"xs",variant:"subtle",color:v,"aria-label":s("Move up"),title:s("Move up"),onClick:l,children:e.jsx(ye,{})}),e.jsx(M,{size:"xs",variant:"subtle",color:v,"aria-label":s("Move down"),title:s("Move down"),onClick:i,children:e.jsx(we,{})}),e.jsx(M,{size:"xs",variant:"subtle",color:v,"aria-label":s("Edit"),title:s("Edit"),onClick:L,children:e.jsx(Se,{})}),e.jsx(M,{size:"xs",variant:"subtle",color:v,"aria-label":s("Duplicate"),title:s("Duplicate"),onClick:x,children:e.jsx(ce,{})}),e.jsx(M,{size:"xs",variant:"subtle",color:v,"aria-label":s("Remove"),title:s("Remove"),onClick:c,children:e.jsx(le,{})})]})]}),j&&e.jsxs(T,{gap:"xs",mt:"xs",children:[e.jsxs(y,{gap:"xs",className:Y["editable-group"],children:[e.jsx(I,{label:s("Line code"),placeholder:"e.g. twl, gz1, sh1",value:a.id,onChange:({currentTarget:{value:g}})=>n==null?void 0:n({id:g}),error:(_=a.id)!=null&&_.match(/[^a-z0-9]/)?s("Line code should be alphanumeric"):void 0}),window.EyeDropper?e.jsx(ke,{label:s("Background colour"),value:a.colour,onChange:g=>n==null?void 0:n({colour:g}),disabled:t&&r}):e.jsx(I,{type:"color",label:s("Background colour"),value:a.colour,onChange:({currentTarget:{value:g}})=>n==null?void 0:n({colour:g}),disabled:t&&r}),t&&e.jsx(Ee,{label:s("Use PantoneÂ®"),checked:r,onChange:({currentTarget:{checked:g}})=>p(g),mt:"xl"}),t&&r&&e.jsx(it,{value:(S=a.pantone)!=null?S:"",onChange:(g,R)=>n==null?void 0:n({pantone:g,colour:R})}),e.jsx(Le,{size:"sm",label:s("Foreground colour"),data:G,value:a.fg,onChange:g=>n==null?void 0:n({fg:g})})]}),e.jsx(ee,{entries:a.nameEntity,onUpdate:(g,R)=>h==null?void 0:h(g,R),onLangSwitch:(g,R)=>u==null?void 0:u(g,R),onRemove:g=>o==null?void 0:o(g)})]})]})}function mt(){const{t:a}=C(),n=B(),l=k(o=>o.ticket.lines),i=m.useRef(null),x=m.useCallback(()=>{setTimeout(()=>{var o,u;(u=(o=i.current)==null?void 0:o.lastElementChild)==null||u.scrollIntoView({behavior:"smooth"})},0)},[i.current]),c=o=>{n(nt(o)),x()},h=()=>{n(at()),x()};return e.jsxs(X,{children:[e.jsxs(Q,{children:[e.jsx(A,{order:2,size:"h4",children:a("Lines")}),e.jsx(lt,{ml:"auto"})]}),e.jsxs(T,{ref:i,py:4,gap:"xs",children:[Object.entries(l).map(([o,u])=>e.jsx(gt,{lineDetail:u,onUpdate:s=>n(st({entryId:o,updates:s})),onMoveUp:()=>n(tt(o)),onMoveDown:()=>n(et(o)),onCopy:()=>c(o),onRemove:()=>n(Ue(o)),onNameUpdate:(s,d)=>n(Qe({entryId:o,lang:s,name:d})),onLangSwitch:(s,d)=>n(Xe({entryId:o,prevLang:s,nextLang:d})),onNameRemove:s=>n(Ze({entryId:o,lang:s}))},o)),e.jsx(f,{size:"xs",variant:"outline",leftSection:e.jsx(ie,{}),ml:"auto",onClick:h,children:a("Add a line")})]})]})}const pt="_content_euz2o_1",jt="_body_euz2o_7",N={content:pt,body:jt,"stepper-root":"_stepper-root_euz2o_14","stepper-content":"_stepper-content_euz2o_21","step-body":"_step-body_euz2o_28"};function ft(a){const{countryErrors:n,cityErrors:l,lineErrors:i,onIgnore:x,onClose:c}=a,{t:h}=C(),{translateName:o}=P();return e.jsxs(e.Fragment,{children:[e.jsxs(T,{gap:"xs",className:N["step-body"],children:[e.jsx(D,{children:h("Your inputs contain the following errors. Please consider fixing it before submitting.")}),n.length>0&&e.jsxs(e.Fragment,{children:[e.jsx(A,{order:3,size:"h5",children:h("Country/Region")}),e.jsx(b,{size:"sm",withPadding:!0,"aria-label":"List of country errors",children:n.map((u,s)=>e.jsx(b.Item,{children:o(q[u])},s))})]}),l.length>0&&e.jsxs(e.Fragment,{children:[e.jsx(A,{order:3,size:"h5",children:h("City")}),e.jsx(b,{size:"sm",withPadding:!0,"aria-label":"List of city errors",children:l.map((u,s)=>e.jsx(b.Item,{children:o(q[u])},s))})]}),Object.values(i).flat().length>0&&e.jsxs(e.Fragment,{children:[e.jsx(A,{order:3,size:"h5",children:h("Lines")}),e.jsx(b,{size:"sm",withPadding:!0,"aria-label":"List of line errors",children:Object.entries(i).map(([u,s])=>e.jsxs(b.Item,{children:[u,e.jsx(b,{size:"sm",withPadding:!0,children:s.map((d,t)=>e.jsx(b.Item,{children:o(q[d])},t))})]},u))})]})]}),e.jsxs(y,{gap:"sm",pt:"xs",children:[e.jsx(f,{variant:"default",ml:"auto",onClick:c,children:h("Go back")}),e.jsx(f,{onClick:x,children:h("Submit anyway")})]})]})}const re=a=>{var n;return!!((n=a.match(/^https?:\/\//))!=null&&n[0])};function bt(a){const{dataSource:n,onDataSourceChange:l,refLink:i,onRefLinkChange:x,justification:c,onJustificationChange:h,onPrev:o,onNext:u}=a,{t:s}=C(),{translateName:d}=P(),t=[{value:"",label:s("Please select..."),disabled:!0},...Object.entries(xe).map(([p,j])=>({value:p,label:d(j)}))],r=!n||!i||!c||!re(i);return e.jsxs(e.Fragment,{children:[e.jsxs(T,{gap:"xs",className:N["step-body"],children:[e.jsx(D,{children:s("Please provide suitable source and justification.")}),e.jsx(U,{label:s("Data source"),value:n,onChange:({currentTarget:{value:p}})=>l(p),data:t}),e.jsx(I,{label:s("Reference link"),placeholder:s("Enter a valid URL, e.g.")+" https://en.wikipedia.org",value:i,onChange:({currentTarget:{value:p}})=>x(p),error:i&&!re(i)?s("URL is invalid"):void 0}),e.jsx(ue,{label:s("Justification"),placeholder:s("Briefly describe your changes and provide justification"),value:c,onChange:({currentTarget:{value:p}})=>h(p),autosize:!0,minRows:3})]}),e.jsxs(y,{gap:"sm",pt:"xs",children:[o&&e.jsx(f,{variant:"default",onClick:o,leftSection:e.jsx(de,{}),children:s("Previous")}),e.jsx(f,{ml:"auto",onClick:u,rightSection:e.jsx(Re,{}),disabled:r,children:s("Next")})]})]})}function Ct(a){var E,w;const{countryEntry:n,cityEntry:l,paletteList:i,dataSource:x,refLink:c,justification:h,onPrev:o}=a,{t:u}=C(),{translateName:s}=P(),d=m.useRef(null),t=["**Data source:** ".concat(x?s(xe[x]):"(REPLACE ME)"),"**Reference link:** ".concat(c||"(REPLACE ME)"),"**Justification:** ".concat(h||"(REPLACE ME)"),ot,H("country",n),H("city",l),H("lines",i)].join("\n\n"),r=new URLSearchParams({template:"new-palettes-request.md",labels:"resources",title:"Resources: New palettes of "+((E=l==null?void 0:l.name)==null?void 0:E.en),body:t}),p=new URLSearchParams({template:"new-palettes-request.md",labels:"resources",title:"Resources: New palettes of "+((w=l==null?void 0:l.name)==null?void 0:w.en)}),j=async()=>{d!=null&&d.current&&(d.current.select(),await navigator.clipboard.writeText(t))};return e.jsxs(e.Fragment,{children:[e.jsxs(T,{gap:"xs",className:N["step-body"],children:[e.jsx(D,{children:u("If the button below doesn't work for you, please follow the instructions below:")}),e.jsxs(b,{type:"ordered",withPadding:!0,children:[e.jsxs(b.Item,{children:[u("Open")," ",e.jsxs(Me,{href:"https://github.com/railmapgen/rmg-palette/issues/new?"+p.toString(),target:"_blank",children:["Issue: New Palettes Request ",e.jsx(Ne,{})]})]}),e.jsxs(b.Item,{children:[u("Paste following text to the issue body")," ",e.jsx(f,{size:"xs",variant:"light",leftSection:e.jsx(ce,{}),onClick:j,children:u("Copy")}),e.jsx(ue,{ref:d,readOnly:!0,defaultValue:t,onClick:({target:L})=>L.select(),mt:"xs",autosize:!0,maxRows:3})]})]})]}),e.jsxs(y,{gap:"sm",pt:"xs",children:[e.jsx(f,{variant:"default",onClick:o,leftSection:e.jsx(de,{}),children:u("Previous")}),e.jsx(f,{ml:"auto",onClick:()=>window.open("https://github.com/railmapgen/rmg-palette/issues/new?"+r.toString(),"_blank"),children:u("1-click open issue")})]})]})}function vt(a){const{isOpen:n,onClose:l}=a,{t:i}=C(),[x,c]=m.useState([]),[h,o]=m.useState([]),[u,s]=m.useState({}),[d,t]=m.useState(""),[r,p]=m.useState(""),[j,E]=m.useState(""),[w,L]=m.useState(!1),[G,v]=m.useState(!1),{countryList:_}=k(K=>K.app),S=k(K=>K.ticket),g=O.getCountryEntry(S),R=O.getCityEntry(S),me=O.getPalettes(S);m.useEffect(()=>{n?(c(O.getCountryErrors(S)),o(O.getCityErrors(S,_)),s(O.getLineErrors(S,_))):(L(!1),t(""),p(""),E(""),v(!1))},[n]);const te=x.length>0||h.length>0||Object.values(u).flat().length>0,V=te&&!w,se=!V&&!G,pe=()=>V?0:se?1:2,je=()=>{!V&&!se&&z.storage.remove(J),l()};return e.jsx(he,{classNames:{content:N.content,body:N.body},opened:n,onClose:je,title:i("Submit palettes"),children:e.jsxs(F,{active:pe(),classNames:{root:N["stepper-root"],content:N["stepper-content"]},children:[e.jsx(F.Step,{label:i("Validate"),color:w?"orange":void 0,completedIcon:w?e.jsx(Te,{size:24}):void 0,children:e.jsx(ft,{countryErrors:x,cityErrors:h,lineErrors:u,onIgnore:()=>L(!0),onClose:l})}),e.jsx(F.Step,{label:i("Justify"),children:e.jsx(bt,{dataSource:d,onDataSourceChange:t,refLink:r,onRefLinkChange:p,justification:j,onJustificationChange:E,onPrev:te?()=>L(!1):void 0,onNext:()=>v(!0)})}),e.jsx(F.Step,{label:i("Submit"),children:e.jsx(Ct,{countryEntry:g,cityEntry:R,paletteList:me,dataSource:d,refLink:r,justification:j,onPrev:()=>v(!1)})})]})})}function yt(a){const{isOpen:n,onClose:l,incomingState:i}=a,{t:x}=C(),c=B(),h=()=>{z.storage.remove(J),l()},o=()=>{i&&c(ge(i)),l()};return e.jsx(he,{opened:n,onClose:l,title:x("Unsaved draft"),children:e.jsxs(W,{direction:"column",children:[e.jsx(D,{children:x("Do you want to continue with your last unsaved ticket?")}),e.jsxs(y,{gap:"xs",mt:"xs",children:[e.jsx(f,{variant:"default",ml:"auto",onClick:h,children:x("Discard")}),e.jsx(f,{onClick:o,children:x("Continue")})]})]})})}function Mt(){const{t:a}=C(),n=B(),{isDataLoading:l}=k(t=>t.app),[i,x]=m.useState(),[c,h]=m.useState(!1),[o,u]=m.useState(!1);m.useEffect(()=>{const t=z.storage.get(J);if(t)try{const r=JSON.parse(t);Object.keys(r.lines).length>0&&Object.values(r.lines)[0].id&&(x(r),h(!0))}catch(r){Pe.error("<TicketView/>, unable to restore draft ticket",t)}},[]);const s=()=>{z.openApp({appId:"rmg-palette"})},d=()=>{n(ge()),z.storage.remove(J),z.event(rt.RESET_TICKET,{})};return e.jsxs(Oe,{w:{base:"100%",sm:600},style:{alignSelf:"center"},children:[e.jsx(ze,{visible:l}),e.jsxs(Ae,{direction:"column",px:"xs",style:{overflowY:"auto"},children:[e.jsx(ht,{}),e.jsx(xt,{}),e.jsx(mt,{})]}),e.jsx(Ie,{}),e.jsx(_e,{children:e.jsxs(y,{flex:1,gap:"sm",children:[e.jsx(f,{variant:"default",onClick:s,children:a("Go back")}),e.jsx(f,{variant:"default",ml:"auto",onClick:d,children:a("Reset")}),e.jsx(f,{onClick:()=>u(!0),children:a("Submit")})]})}),e.jsx(yt,{isOpen:c,onClose:()=>h(!1),incomingState:i}),e.jsx(vt,{isOpen:o,onClose:()=>u(!1)})]})}export{Mt as default};
